<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="magrittr">
<title>Design tradeoffs • magrittr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.5/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.5/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Design tradeoffs">
<meta property="og:description" content="magrittr">
<meta property="og:image" content="https://magrittr.tidyverse.org/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="magrittr.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">magrittr</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.0.3.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/magrittr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/tradeoffs.html">Design tradeoffs</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-news">News</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-news">
    <h6 class="dropdown-header" data-toc-skip>Releases</h6>
    <a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/11/magrittr-2-0-is-here/">Version 2.0.0</a>
    <a class="external-link dropdown-item" href="https://blog.rstudio.com/2014/12/01/magrittr-1-5/">Version 1.5.0</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../news/index.html">Changelog</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tidyverse/magrittr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Design tradeoffs</h1>
                        <h4 data-toc-skip class="author">Hadley
Wickham</h4>
                        <h4 data-toc-skip class="author">Lionel
Henry</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/magrittr/blob/HEAD/vignettes/tradeoffs.Rmd" class="external-link"><code>vignettes/tradeoffs.Rmd</code></a></small>
      <div class="d-none name"><code>tradeoffs.Rmd</code></div>
    </div>

    
    
<p>There are many different ways that magrittr could implement the pipe.
The goal of this document is to elucidate the variations, and the
various pros and cons of each approach. This document is primarily aimed
at the magrittr developers (so we don’t forget about important
considerations), but will be of interest to anyone who wants to
understand pipes better, or to create their own pipe that makes
different tradeoffs</p>
<div class="section level2">
<h2 id="code-transformation">Code transformation<a class="anchor" aria-label="anchor" href="#code-transformation"></a>
</h2>
<p>There are three main options for how we might transform a pipeline in
base R expressions. Here they are illustrated with
<code>x %&gt;% foo() %&gt;% bar()</code>:</p>
<ul>
<li>
<p><strong>Nested</strong></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bar</span><span class="op">(</span><span class="fu">foo</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Eager (mask)</strong>, masking environment</p>
<p>This is essentially how <code>%&gt;%</code> has been implemented
prior to magrittr 2.0:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">.</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">.</span> <span class="op">&lt;-</span> <span class="fu">foo</span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span>
<span>  <span class="fu">bar</span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Eager (mask-num)</strong>: masking environment, numbered
placeholder</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">...1</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">...2</span> <span class="op">&lt;-</span> <span class="fu">foo</span><span class="op">(</span><span class="va">...1</span><span class="op">)</span></span>
<span>  <span class="fu">bar</span><span class="op">(</span><span class="va">...2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Eager (lexical)</strong>: lexical environment</p>
<p>This variant assigns pipe expressions to the placeholder
<code>.</code> in the current environment. This assignment is temporary:
once the pipe has returned, the placeholder binding is reset to its
previous state.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">with_dot_cleanup</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Initialises `.` in the caller environment and resets it on exit.</span></span>
<span>  <span class="co"># (We use `:=` instead of `=` to avoid partial matching.)</span></span>
<span>  <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/local_bindings.html" class="external-link">local_bindings</a></span><span class="op">(</span><span class="va">.</span> <span class="op">:=</span> <span class="cn">NULL</span>, .env <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">expr</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">with_dot_cleanup</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">.</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>  <span class="va">.</span> <span class="op">&lt;-</span> <span class="fu">foo</span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span>
<span>  <span class="fu">bar</span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Lazy (mask)</strong>: masking environments</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mask1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">env</span><span class="op">)</span></span>
<span><span class="va">mask2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">env</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html" class="external-link">delayedAssign</a></span><span class="op">(</span><span class="st">"."</span>, <span class="va">x</span>, <span class="va">mask1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html" class="external-link">delayedAssign</a></span><span class="op">(</span><span class="st">"."</span>, <span class="fu">foo</span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="va">mask2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mask2</span>, <span class="fu">bar</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Lazy (mask-num)</strong>: masking environment, numbered
placeholder</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html" class="external-link">delayedAssign</a></span><span class="op">(</span><span class="st">"...1"</span>, <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html" class="external-link">delayedAssign</a></span><span class="op">(</span><span class="st">"...2"</span>, <span class="fu">foo</span><span class="op">(</span><span class="va">...1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">bar</span><span class="op">(</span><span class="va">...2</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p><strong>Lazy (lexical-num)</strong>: lexical environment,
numbered placeholder</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html" class="external-link">delayedAssign</a></span><span class="op">(</span><span class="st">"...1"</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/delayedAssign.html" class="external-link">delayedAssign</a></span><span class="op">(</span><span class="st">"...2"</span>, <span class="fu">foo</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">bar</span><span class="op">(</span><span class="va">...2</span><span class="op">)</span></span></code></pre></div>
</li>
</ul>
<p>We’ll first explore the desired properties we might want a pipe to
possess and then see how each of the three variants does.</p>
</div>
<div class="section level2">
<h2 id="desired-properties">Desired properties<a class="anchor" aria-label="anchor" href="#desired-properties"></a>
</h2>
<p>These are the properties that we might want a pipe to possess,
roughly ordered from most important to least important.</p>
<ul>
<li><p><strong>Visibility</strong>: the visibility of the final function
in the pipe should be preserved. This is important so that pipes that
end in a side-effect function (which generally returns its first
argument invisibly) do not print.</p></li>
<li><p><strong>Multiple placeholders</strong>: each component of the
pipe should only be evaluated once even when there are multiple
placeholders, so that <code>sample(10) %&gt;% cbind(., .)</code> yields
two columns with the same value. Relatedly,
<code>sample(10) %T&gt;% print() %T&gt;% print()</code> must print the
same values twice.</p></li>
<li>
<p><strong>Lazy evaluation</strong>: steps of the pipe should only
be evaluated when actually needed. This is a useful property as it means
that pipes can handle code like <code>stop("!") %&gt;% try()</code>,
making pipes capable of capturing a wider range of R expressions.</p>
<p>On the other hand, it might have surprising effects. For instance if
a function that suppresses warnings is added to the end of a pipeline,
the suppression takes effect for the whole pipeline.</p>
</li>
<li>
<p><strong>Persistence of piped values</strong>: arguments are not
necessarily evaluated right away by the piped function. Sometimes they
are evaluated long after the pipeline has returned, for example when a
function factory is piped. With persistent piped values, the constructed
function can be called at any time:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">factory</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA</span></span></code></pre></div>
</li>
<li><p><strong>Refcount neutrality</strong>: the return value of the
pipeline should have a reference count of 1 so it can be mutated in
place in further manipulations.</p></li>
<li><p><strong>Eager unbinding</strong>: pipes are often used with large
data objects, so intermediate objects in the pipeline should be unbound
as soon as possible so they are available for garbage
collection.</p></li>
<li><p><strong>Progressive stack</strong>: using the pipe should add as
few entries to the call stack as possible, so that
<code><a href="https://rdrr.io/r/base/traceback.html" class="external-link">traceback()</a></code> is maximally useful.</p></li>
<li><p><strong>Lexical side effects</strong>: side effects should occur
in the current lexical environment. This way,
<code>NA %&gt;% { foo &lt;- . }</code> assigns the piped value in the
current environment and <code>NA %&gt;% { return(.) }</code> returns
from the function that contains the pipeline.</p></li>
<li><p><strong>Continuous stack</strong>: the pipe should not affect the
chain of parent frames. This is important for tree representations of
the call stack.</p></li>
</ul>
<p>It is possible to have proper visibility and a neutral impact on
refcounts with all implementations by being a bit careful, so we’ll only
consider the other properties:</p>
<table style="width:100%;" class="table">
<colgroup>
<col width="15%">
<col width="7%">
<col width="11%">
<col width="13%">
<col width="13%">
<col width="10%">
<col width="13%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th></th>
<th align="center">Nested</th>
<th align="center">Eager<br>(mask)</th>
<th align="center">Eager<br>(mask-num)</th>
<th align="center">Eager<br>(lexical)</th>
<th align="center">Lazy<br>(mask)</th>
<th align="center">Lazy<br>(mask-num)</th>
<th align="center">Lazy<br>(lexical-num)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Multiple placeholders</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
</tr>
<tr class="even">
<td>Lazy evaluation</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
</tr>
<tr class="odd">
<td>Persistence</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
</tr>
<tr class="even">
<td>Eager unbinding</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr class="odd">
<td>Progressive stack</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">❌</td>
</tr>
<tr class="even">
<td>Lexical effects</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
<tr class="odd">
<td>Continuous stack</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✅</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="implications-of-design-decisions">Implications of design decisions<a class="anchor" aria-label="anchor" href="#implications-of-design-decisions"></a>
</h3>
<p>Some properties are a direct reflection of the high level design
decisions.</p>
<div class="section level4">
<h4 id="placeholder-binding">Placeholder binding<a class="anchor" aria-label="anchor" href="#placeholder-binding"></a>
</h4>
<p>The nested pipe does not assign piped expressions to a placeholder.
All the other variants perform this assignment. This means that with a
nested rewrite approach, it isn’t possible to have multiple placeholders
unless the piped expression is pasted multiple times. This would cause
multiple evaluations with deleterious effects:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Becomes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Assigning to the placeholder within an argument would preserve the
nestedness and lazyness. However that wouldn’t work properly because
there’s no guarantee that the first argument will be evaluated before
the second argument.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">foo</span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="fu">foo</span><span class="op">(</span><span class="va">.</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span></span></code></pre></div>
<p>For these reasons, the nested pipe does not support multiple
placeholders. By contrast, all the other variants assign the result of
pipe expressions to the placeholder. There are variations in how the
placeholder binding is created (lazily or eagerly, in a mask or in the
current environment, with numbered symbols or with a unique symbol) but
all these variants allow multiple placeholders.</p>
</div>
<div class="section level4">
<h4 id="masking-environment">Masking environment<a class="anchor" aria-label="anchor" href="#masking-environment"></a>
</h4>
<p>Because the local variants of the pipe evaluate in a mask, they do
not have lexical effects or a continuous stack. This is unlike the
lexical variants that evaluate in the current environment.</p>
</div>
<div class="section level4">
<h4 id="laziness">Laziness<a class="anchor" aria-label="anchor" href="#laziness"></a>
</h4>
<p>Unlike the lazy variants, all eager versions implementing the pipe
with iterated evaluation do not pass the lazy evaluation criterion.</p>
<p>Secondly, no lazy variant passes the progressive stack criterion. By
construction, lazy evaluation requires pushing all the pipe expressions
on the stack before evaluation starts. Conversely, all eager variants
have a progressive stack.</p>
</div>
<div class="section level4">
<h4 id="numbered-placeholders">Numbered placeholders<a class="anchor" aria-label="anchor" href="#numbered-placeholders"></a>
</h4>
<p>None of the variants that use numbered placeholders can unbind piped
values eagerly. This is how they achieve persistence of these
bindings.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="three-implementations">Three implementations<a class="anchor" aria-label="anchor" href="#three-implementations"></a>
</h2>
<p>The GNU R team is considering implementing the nested approach in
base R with a parse-time code transformation (just like
<code>-&gt;</code> is transformed to <code>&lt;-</code> by the
parser).</p>
<p>We have implemented three approaches in magrittr:</p>
<ul>
<li>The nested pipe</li>
<li>The eager lexical pipe</li>
<li>The lazy masking pipe</li>
</ul>
<p>These approaches have complementary strengths and weaknesses.</p>
<div class="section level3">
<h3 id="nested-pipe">Nested pipe<a class="anchor" aria-label="anchor" href="#nested-pipe"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`%|&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va"><a href="../reference/pipe_eager_lexical.html">pipe_nested</a></span></span></code></pre></div>
<div class="section level4">
<h4 id="multiple-placeholders">Multiple placeholders ❌<a class="anchor" aria-label="anchor" href="#multiple-placeholders"></a>
</h4>
<p>The nested pipe does not bind expressions to a placeholder and so
can’t support multiple placeholders.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">"foo"</span> <span class="op">%|&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Can't use multiple placeholders.</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="lazy-evaluation">Lazy evaluation ✅<a class="anchor" aria-label="anchor" href="#lazy-evaluation"></a>
</h4>
<p>Because it relies on the usual rules of argument application, the
nested pipe is lazy.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"oh no"</span><span class="op">)</span> <span class="op">%|&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span>silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="st">"success"</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "success"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="persistence-and-eager-unbinding">Persistence and eager unbinding ✅<a class="anchor" aria-label="anchor" href="#persistence-and-eager-unbinding"></a>
</h4>
<p>The pipe expressions are binded as promises within the execution
environment of each function. This environment persists as long as a
promise holds onto it. Evaluating the promise discards the reference to
the environment which becomes available for garbage collection.</p>
<p>For instance, here is a function factory that creates a function. The
constructed function returns the value supplied at the time of
creation:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">factory</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu">factory</span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>This does not cause any issue with the nested pipe:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op">%|&gt;%</span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="progressive-stack">Progressive stack ❌<a class="anchor" aria-label="anchor" href="#progressive-stack"></a>
</h4>
<p>Because the piped expressions are lazily evaluated, the whole
pipeline is pushed on the stack before execution starts. This results in
a more complex backtrace than necessary:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">faulty</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"tilt"</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span></span>
<span><span class="fu">faulty</span><span class="op">(</span><span class="op">)</span> <span class="op">%|&gt;%</span> <span class="fu">f</span><span class="op">(</span><span class="op">)</span> <span class="op">%|&gt;%</span> <span class="fu">g</span><span class="op">(</span><span class="op">)</span> <span class="op">%|&gt;%</span> <span class="fu">h</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in faulty() : tilt</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/traceback.html" class="external-link">traceback</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 7: stop("tilt")</span></span>
<span><span class="co">#&gt; 6: faulty()</span></span>
<span><span class="co">#&gt; 5: f(faulty())</span></span>
<span><span class="co">#&gt; 4: g(f(faulty()))</span></span>
<span><span class="co">#&gt; 3: h(g(f(faulty())))</span></span>
<span><span class="co">#&gt; 2: .External2(magrittr_pipe) at pipe.R#181</span></span>
<span><span class="co">#&gt; 1: faulty() %|&gt;% f() %|&gt;% g() %|&gt;% h()</span></span></code></pre></div>
<p>Also note how the expressions in the backtrace look different from
the actual code. This is because of the nested rewrite of the
pipeline.</p>
</div>
<div class="section level4">
<h4 id="lexical-effects">Lexical effects ✅<a class="anchor" aria-label="anchor" href="#lexical-effects"></a>
</h4>
<p>This is a benefit of using the normal R rules of evaluation. Side
effects occur in the correct environment:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foo</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="cn">TRUE</span> <span class="op">%|&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="st">"foo"</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="va">foo</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Control flow has the correct behaviour:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="cn">TRUE</span> <span class="op">%|&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="cn">FALSE</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="continuous-stack">Continuous stack ✅<a class="anchor" aria-label="anchor" href="#continuous-stack"></a>
</h4>
<p>Because evaluation occurs in the current environment, the stack is
continuous. Let’s instrument errors with a structured backtrace to see
what that means:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>error <span class="op">=</span> <span class="fu">rlang</span><span class="fu">::</span><span class="va"><a href="https://rlang.r-lib.org/reference/entrace.html" class="external-link">entrace</a></span><span class="op">)</span></span></code></pre></div>
<p>The tree representation of the backtrace correctly represents the
hierarchy of execution frames:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foobar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">%|&gt;%</span> <span class="fu">quux</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">quux</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">%|&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="st">"tilt"</span> <span class="op">%|&gt;%</span> <span class="fu">foobar</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in x %|&gt;% stop() : tilt</span></span>
<span></span>
<span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/last_error.html" class="external-link">last_trace</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;error/rlang_error&gt;</span></span>
<span><span class="co">#&gt; tilt</span></span>
<span><span class="co">#&gt; Backtrace:</span></span>
<span><span class="co">#&gt;     █</span></span>
<span><span class="co">#&gt;  1. ├─"tilt" %|&gt;% foobar()</span></span>
<span><span class="co">#&gt;  2. └─global::foobar("tilt")</span></span>
<span><span class="co">#&gt;  3.   ├─x %|&gt;% quux()</span></span>
<span><span class="co">#&gt;  4.   └─global::quux(x)</span></span>
<span><span class="co">#&gt;  5.     └─x %|&gt;% stop()</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="eager-lexical-pipe">Eager lexical pipe<a class="anchor" aria-label="anchor" href="#eager-lexical-pipe"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`%!&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va"><a href="../reference/pipe_eager_lexical.html">pipe_eager_lexical</a></span></span></code></pre></div>
<div class="section level4">
<h4 id="multiple-placeholders-1">Multiple placeholders ✅<a class="anchor" aria-label="anchor" href="#multiple-placeholders-1"></a>
</h4>
<p>Pipe expressions are eagerly assigned to the placeholder. This makes
it possible to use the placeholder multiple times without causing
multiple evaluations.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">"foo"</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "foo"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "foo"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="lazy-evaluation-1">Lazy evaluation ❌<a class="anchor" aria-label="anchor" href="#lazy-evaluation-1"></a>
</h4>
<p>Assignment forces eager evaluation of each step.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"oh no"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span>silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="st">"success"</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Error in stop("oh no") %!&gt;% try(silent = TRUE): oh no</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="persistence">Persistence: ❌<a class="anchor" aria-label="anchor" href="#persistence"></a>
</h4>
<p>Because we’re updating the value of <code>.</code> at each step, the
piped expressions are not persistent. This has subtle effects when the
piped expressions are not evaluated right away.</p>
<p>With the eager pipe we get rather confusing results with the factory
function if we try to call the constructed function in the middle of the
pipeline. In the following snippet the placeholder <code>.</code> is
binded to the constructed function itself rather than the initial value
<code>TRUE</code>, by the time the function is called:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="op">{</span> <span class="fu">.</span><span class="op">(</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; function() x</span></span>
<span><span class="co">#&gt; &lt;bytecode: 0x5586630d6a08&gt;</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55866062e4a8&gt;</span></span></code></pre></div>
<p>Also, since we’re binding <code>.</code> in the current environment,
we need to clean it up once the pipeline has returned. At that point,
the placeholder no longer exists:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in fn(): object '.' not found</span></span></code></pre></div>
<p>Or it has been reset to its previous value, if any:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.</span> <span class="op">&lt;-</span> <span class="st">"wrong"</span></span>
<span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "wrong"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="eager-unbinding">Eager unbinding: ✅<a class="anchor" aria-label="anchor" href="#eager-unbinding"></a>
</h4>
<p>This is the flip side of updating the value of the placeholder at
each step. The previous intermediary values can be collected right
away.</p>
</div>
<div class="section level4">
<h4 id="progressive-stack-1">Progressive stack: ✅<a class="anchor" aria-label="anchor" href="#progressive-stack-1"></a>
</h4>
<p>Since pipe expressions are evaluated one by one as they come, only
the relevant part of the pipeline is on the stack when an error is
thrown:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">faulty</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"tilt"</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span></span>
<span><span class="fu">faulty</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="fu">f</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="fu">g</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="fu">h</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in faulty() : tilt</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/traceback.html" class="external-link">traceback</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 4: stop("tilt")</span></span>
<span><span class="co">#&gt; 3: faulty()</span></span>
<span><span class="co">#&gt; 2: .External2(magrittr_pipe) at pipe.R#163</span></span>
<span><span class="co">#&gt; 1: faulty() %!&gt;% f() %!&gt;% g() %!&gt;% h()</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="lexical-effects-and-continuous-stack">Lexical effects and continuous stack: ✅<a class="anchor" aria-label="anchor" href="#lexical-effects-and-continuous-stack"></a>
</h4>
<p>Evaluating in the current environment rather than in a mask produces
the correct side effects:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foo</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="cn">NA</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="op">{</span> <span class="va">foo</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>; <span class="va">.</span> <span class="op">}</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span></span>
<span><span class="va">foo</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="cn">TRUE</span> <span class="op"><a href="../reference/pipe-eager.html">%!&gt;%</a></span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="cn">FALSE</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="lazy-masking-pipe">Lazy masking pipe<a class="anchor" aria-label="anchor" href="#lazy-masking-pipe"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`%?&gt;%`</span> <span class="op">&lt;-</span> <span class="fu">magrittr</span><span class="fu">::</span><span class="va"><a href="../reference/pipe_eager_lexical.html">pipe_lazy_masking</a></span></span></code></pre></div>
<div class="section level4">
<h4 id="multiple-placeholders-2">Multiple placeholders ✅<a class="anchor" aria-label="anchor" href="#multiple-placeholders-2"></a>
</h4>
<p>Pipe expressions are lazily assigned to the placeholder. This makes
it possible to use the placeholder multiple times without causing
multiple evaluations.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="st">"foo"</span> <span class="op">%?&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] "foo"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] "foo"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="lazy-evaluation-2">Lazy evaluation ✅<a class="anchor" aria-label="anchor" href="#lazy-evaluation-2"></a>
</h4>
<p>Arguments are assigned with <code><a href="https://rdrr.io/r/base/delayedAssign.html" class="external-link">delayedAssign()</a></code> and lazily
evaluated:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"oh no"</span><span class="op">)</span> <span class="op">%?&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span>silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="st">"success"</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] "success"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="persistence-1">Persistence: ✅<a class="anchor" aria-label="anchor" href="#persistence-1"></a>
</h4>
<p>The lazy masking pipe uses one masking environment per pipe
expression. This allows persistence of the intermediary values and out
of order evaluation. The factory function works as expected for
instance:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="op">%?&gt;%</span> <span class="fu">factory</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="eager-unbinding-1">Eager unbinding: ✅<a class="anchor" aria-label="anchor" href="#eager-unbinding-1"></a>
</h4>
<p>Because we use one mask environment per pipe expression, the
intermediary values can be collected as soon as they are no longer
needed.</p>
</div>
<div class="section level4">
<h4 id="progressive-stack-2">Progressive stack: ❌<a class="anchor" aria-label="anchor" href="#progressive-stack-2"></a>
</h4>
<p>With a lazy pipe the whole pipeline is pushed onto the stack before
evaluation.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">faulty</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"tilt"</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">2</span></span>
<span><span class="va">h</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">3</span></span>
<span></span>
<span><span class="fu">faulty</span><span class="op">(</span><span class="op">)</span> <span class="op">%?&gt;%</span> <span class="fu">f</span><span class="op">(</span><span class="op">)</span> <span class="op">%?&gt;%</span> <span class="fu">g</span><span class="op">(</span><span class="op">)</span> <span class="op">%?&gt;%</span> <span class="fu">h</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in faulty() : tilt</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/traceback.html" class="external-link">traceback</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 7: stop("tilt")</span></span>
<span><span class="co">#&gt; 6: faulty()</span></span>
<span><span class="co">#&gt; 5: f(.)</span></span>
<span><span class="co">#&gt; 4: g(.)</span></span>
<span><span class="co">#&gt; 3: h(.)</span></span>
<span><span class="co">#&gt; 2: .External2(magrittr_pipe) at pipe.R#174</span></span>
<span><span class="co">#&gt; 1: faulty() %?&gt;% f() %?&gt;% g() %?&gt;% h()</span></span></code></pre></div>
<p>Note however how the backtrace is less cluttered than with the nested
pipe approach, thanks to the placeholder.</p>
</div>
<div class="section level4">
<h4 id="lexical-effects-1">Lexical effects ❌<a class="anchor" aria-label="anchor" href="#lexical-effects-1"></a>
</h4>
<p>The lazy pipe evaluates in a mask. This causes lexical side effects
to occur in the incorrect environment.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foo</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="cn">TRUE</span> <span class="op">%?&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="st">"foo"</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="va">foo</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>Stack-sensitive functions like <code><a href="https://rdrr.io/r/base/function.html" class="external-link">return()</a></code> function cannot
find the proper frame environment:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="cn">TRUE</span> <span class="op">%?&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="cn">FALSE</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">fn</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="continuous-stack-1">Continuous stack ❌<a class="anchor" aria-label="anchor" href="#continuous-stack-1"></a>
</h4>
<p>The masking environment causes a discontinuous stack tree:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">foobar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">%?&gt;%</span> <span class="fu">quux</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">quux</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">%?&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="st">"tilt"</span> <span class="op">%?&gt;%</span> <span class="fu">foobar</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in x %?&gt;% stop() : tilt</span></span>
<span></span>
<span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/last_error.html" class="external-link">last_trace</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;error/rlang_error&gt;</span></span>
<span><span class="co">#&gt; tilt</span></span>
<span><span class="co">#&gt; Backtrace:</span></span>
<span><span class="co">#&gt;     █</span></span>
<span><span class="co">#&gt;  1. ├─"tilt" %?&gt;% foobar()</span></span>
<span><span class="co">#&gt;  2. ├─global::foobar(.)</span></span>
<span><span class="co">#&gt;  3. │ └─x %?&gt;% quux()</span></span>
<span><span class="co">#&gt;  4. └─global::quux(.)</span></span>
<span><span class="co">#&gt;  5.   └─x %?&gt;% stop()</span></span></code></pre></div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://stefanbache.dk" class="external-link">Stefan Milton Bache</a>, <a href="http://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer>
</body>
</html>
